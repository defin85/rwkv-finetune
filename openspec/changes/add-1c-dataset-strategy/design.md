## Context
Проект дообучает RWKV v7 под 1C:Enterprise программирование и уже имеет рабочий pipeline `jsonl -> binidx -> train` через `scripts/prepare_binidx.sh` и `scripts/train.sh`.

Критическая проблема сейчас не в отсутствии тренировки, а в отсутствии формального data lifecycle: откуда берутся данные, как проверяются, как делятся на train/eval, как версионируются и как измеряется улучшение.

Дополнительно зафиксированы входные ограничения:
- mixed-use источники допустимы;
- приоритет одновременно на генерацию и рефакторинг;
- пользовательские промпты только на русском языке.

## Goals / Non-Goals
- Goals:
  - Ввести стандартизованный lifecycle датасетов для RWKV v7/1C.
  - Обеспечить воспроизводимость релизов датасетов через manifest и версионирование.
  - Снизить риск деградации качества через обязательные quality gates и leakage-контроль.
  - Обеспечить измеримость прогресса по отдельным классам задач.
- Non-Goals:
  - Не определять новые алгоритмы обучения RWKV-PEFT.
  - Не внедрять в этой change конкретную реализацию скриптов/CI.
  - Не описывать полный юридический аудит по странам/юрисдикциям.

## Decisions
- Decision: Двухконтурная модель данных (`core` + `extended`).
  - Rationale: mixed-use допустим, но требуется прозрачное разделение данных по лицензионному риску и повторному использованию.
  - Alternatives considered:
    - Единый контур: проще, но хуже управляет рисками лицензий и повторной публикации.
    - Только permissive: снижает риски, но сужает покрытие домена и темп прогресса.

- Decision: Task taxonomy с фиксированным базовым балансом.
  - Rationale: предотвращает перекос в один тип задач и упрощает анализ качества.
  - Baseline for v1:
    - генерация: 35%;
    - рефакторинг: 35%;
    - запросы 1C: 15%;
    - объяснение/ревью: 15%.
  - Допуск для отклонений в релизе: не более 5 процентных пунктов по каждой категории.
  - Alternatives considered:
    - Свободный набор без квот: быстрее старт, но нестабильное качество между релизами.

- Decision: Русскоязычная политика промптов.
  - Rationale: соответствует целевому использованию и требованиям владельца проекта.
  - Alternatives considered:
    - RU+EN: увеличивает покрытие, но размывает целевой профиль модели на первом этапе.

- Decision: Обязательные quality gates до выпуска версии.
  - Rationale: качество датасета сильнее влияет на результат, чем микротюнинг гиперпараметров.
  - Alternatives considered:
    - Постфактум-фильтрация после обучения: дешевле upfront, но приводит к дорогим неудачным запускам.

- Decision: Репозиторно-временной split и отдельные eval-наборы.
  - Rationale: снижает риск data leakage и переоценки качества.
  - Alternatives considered:
    - Случайный split: проще, но выше риск near-dup leakage.

## Data Model
- Dataset release:
  - `version`: семантическая версия датасета (`v0`, `v1`, ...).
  - `contour`: `core` или `extended`.
  - `samples`: массив записей `{"text": "User: ...\nAssistant: ..."}`.
  - `manifest`: метаданные происхождения и проверок.

- Manifest (минимальные поля):
  - `sample_id`, `source_type`, `source_uri`, `license`, `origin_ref`, `category`, `split`, `lang`, `hash_exact`, `hash_near_group`, `pii_scan_status`, `bsl_parse_status`, `created_at`.

## Release Flow
1. Ingest источников.
2. Нормализация в единый формат prompt/response.
3. Классификация по task taxonomy.
4. Dedup (exact + near).
5. Quality gates (BSL parse/diagnostics, secrets/PII, language policy).
6. Split в train/eval по репозиториям и времени.
7. Заморозка версии (`manifest` + артефакты).
8. Экспорт `train.jsonl` в формат совместимый с `prepare_binidx.sh`.
9. Post-train evaluation и backlog hard-cases для следующей версии.

## Risks / Trade-offs
- Риск: leakage между train/eval через near-duplicates.
  - Mitigation: обязательный near-dedup и split по репозиториям/времени.
- Риск: неравномерное качество источников mixed-use.
  - Mitigation: двухконтурная модель + provenance и фильтры качества.
- Риск: переоптимизация на стиль без функциональной корректности.
  - Mitigation: отдельные eval-наборы по генерации и рефакторингу + acceptance-тесты задач.
- Риск: рост сложности пайплайна.
  - Mitigation: поэтапный rollout (v0 -> v1 -> v2) с минимально жизнеспособным набором проверок на старте.

## Acceptance Thresholds for v1
- Доля категорий задач должна соответствовать baseline с допуском до 5 п.п.
- Доли генерации и рефакторинга должны быть паритетными в пределах допуска.
- Все пользовательские промпты в train/eval должны быть на русском языке.
- Любой образец без provenance/license в `extended` контуре исключается из релиза.

## Migration Plan
1. Зафиксировать capability и требования в OpenSpec.
2. На этапе реализации добавить структуру каталогов и schema manifest.
3. Внедрить минимальный lifecycle для v0 (ingest/normalize/dedup/split/export).
4. Запустить smoke-обучение и оценку на выделенном eval-наборе.
5. Расширить quality gates и автоматизацию на v1+.

## Open Questions
- Нужна ли отдельная метрика качества по поддоменам 1C (документы, регистры, СКД, запросы) уже в v1, или достаточно общей метрики по четырём категориям задач?
